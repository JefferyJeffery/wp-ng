angular.module("jtt_aping",["jtt_aping_jsonloader","jtt_aping_xml","jtt_aping_ng_array","jtt_aping_local_storage","jtt_aping_json_string"]),angular.module("jtt_aping").config(["$provide",function(e){e.value("apingDefaultSettings",{apingApiKeys:{}})}]).value("apingResults",{}).directive("aping",["apingResults","apingDefaultSettings","apingUtilityHelper","$templateRequest","$compile",function(e,r,t,a,n){return{restrict:"EA",transclude:!0,template:"<ng-transclude></ng-transclude>",scope:{model:"@",getNativeData:"@",items:"@",maxItems:"@",orderBy:"@",orderReverse:"@",templateUrl:"@",payloadJson:"@",removeDoubles:"@",mergeDoubles:"@",idBy:"@",resultProperty:"@",resultName:"@",valueName:"@",protocol:"@"},link:function(e,t,i,s,o){function l(r){angular.isDefined(r)&&"$NONE"!==r?a(r).then(function(r){var a=angular.element(r);t.empty().append(a),n(a)(e)}):o(e,function(e,r){t.html(""),t.append(e),n(e)(r)}),e.$broadcast("apiNG.templateRendered")}var u=e.templateUrl;e.$watch("templateUrl",function(){l(e.templateUrl)}),angular.isUndefined(u)&&angular.isDefined(r.templateUrl)&&(u=r.templateUrl,l(u))},controller:["$scope",function(a){angular.isUndefined(a.resultName)&&(angular.isUndefined(a.resultProperty)?a.resultName="results":a.resultName=a.resultProperty),a[a.resultName]=[],a.payload=a.payloadJson?t.replaceSingleQuotesAndParseJson(a.payloadJson):{},this.getAppSettings=function(){var e,t,n,i,s,o,l,u,g,d;return u=angular.isDefined(a.valueName)?a.valueName:void 0,e=angular.isDefined(a.items)?a.items:angular.isDefined(r.items)?r.items:void 0,t=angular.isDefined(a.maxItems)?a.maxItems:angular.isDefined(r.maxItems)?r.maxItems:void 0,n=angular.isDefined(a.getNativeData)?a.getNativeData:!!angular.isDefined(r.getNativeData)&&r.getNativeData,t=angular.isDefined(a.maxItems)?a.maxItems:angular.isDefined(r.maxItems)?r.maxItems:void 0,s=angular.isDefined(a.orderBy)?a.orderBy:angular.isDefined(r.orderBy)?r.orderBy:void 0,i=angular.isDefined(a.orderReverse)?a.orderReverse:!!angular.isDefined(r.orderReverse)&&r.orderReverse,o=angular.isDefined(a.removeDoubles)?a.removeDoubles:!!angular.isDefined(r.removeDoubles)&&r.removeDoubles,l=angular.isDefined(a.mergeDoubles)?a.mergeDoubles:!!angular.isDefined(r.mergeDoubles)&&r.mergeDoubles,g=angular.isDefined(a.idBy)?a.idBy:angular.isDefined(r.idBy)?r.idBy:void 0,d=angular.isDefined(a.protocol)?a.protocol:angular.isDefined(r.protocol)?r.protocol:void 0,{model:a.model||r.model||"native",getNativeData:n,items:e,maxItems:t,orderBy:s,orderReverse:i,removeDoubles:o,mergeDoubles:l,idBy:g,valueName:u,protocol:d}},this.concatToResults=function(r){angular.isUndefined(a.resultName)&&(angular.isUndefined(a.resultProperty)?a.resultName="results":a.resultName=a.resultProperty);var n=a[a.resultName].concat(r),i=this.getAppSettings();angular.isDefined(i.idBy)&&(n=t.createIdByPropertiesForArray(n,i.idBy),!0!==i.mergeDoubles&&"true"!==i.mergeDoubles||(n=t.mergeDuplicateObjectsFromArray(n,!1===i.orderBy||"false"===i.orderBy||"$NONE"===i.orderBy))),!0!==i.removeDoubles&&"true"!==i.removeDoubles||!0!==i.mergeDoubles&&"true"!==i.mergeDoubles&&(n=t.removeDuplicateObjectsFromArray(n,!1===i.orderBy||"false"===i.orderBy||"$NONE"===i.orderBy,angular.isDefined(i.idBy))),angular.isDefined(i.orderBy)&&!1!==i.orderBy&&"false"!==i.orderBy&&"$NONE"!==i.orderBy&&("$RANDOM"===i.orderBy?n=t.shuffleArray(n):n.sort(t.sortArrayByProperty(i.orderBy))),!0!==i.orderReverse&&"true"!==i.orderReverse||"$RANDOM"===i.orderBy||n.reverse(),i.maxItems>-1&&n.length>i.maxItems&&(n=n.splice(0,i.maxItems)),angular.isDefined(i.valueName)&&(e[i.valueName]=n),a[a.resultName]=n,a.$broadcast("apiNG.resultMerged",{resultName:a.resultName,valueName:a.valueName}),a.$emit("apiNG.resultMerged",{resultName:a.resultName,valueName:a.valueName})},this.apply=function(){a.$apply()}}]}}]),angular.module("jtt_aping").service("apingTimeHelper",function(){this.getTimestampFromDateString=function(e,r,t){if((angular.isUndefined(r)||isNaN(r))&&(r=1),(angular.isUndefined(t)||isNaN(t))&&(t=0),"string"==typeof e){var a=e.split(/[^0-9]/);try{return parseInt(Math.round(new Date(a[0],a[1]-1,a[2],a[3],a[4],a[5])/1e3*r)+t,10)}catch(e){return 0}}return 0}}).service("apingUtilityHelper",["apingInputObjects","apingDefaultSettings",function(e,r){this.getApiCredentials=function(e,t){return!(!r.apingApiKeys||!r.apingApiKeys[e])&&r.apingApiKeys[e][Math.floor(Math.random()*r.apingApiKeys[e].length)][t]},this.parseJsonFromAttributes=function(e,r,t){return this.parseRequestsFromAttributes(e,r,t)},this.getDifference=function(e,r){return e>r?e-r:r-e},this.parseRequestsFromAttributes=function(r,t,a){if("string"!=typeof r||!r)return[];var n=[],i=this.replaceSingleQuotesAndParseJson(r);return i.constructor===Array?angular.forEach(i,function(r){r.platform=t,a&&(angular.isUndefined(r.items)&&angular.isDefined(a.items)&&(r.items=a.items),angular.isUndefined(r.model)&&angular.isDefined(a.model)&&(r.model=a.model));var i=e.getNew("request",r);n.push(i)}):n.push(i),n},this.replaceSingleQuotesAndParseJson=function(e){return angular.fromJson(e.replace(/'/g,'"'))},this.sortArrayByProperty=function(e){var r=1;return"-"===e[0]&&(r=-1,e=e.substr(1)),function(t,a){return(t[e]<a[e]?-1:t[e]>a[e]?1:0)*r}},this.shuffleArray=function(e){for(var r=e.length-1;r>0;r--){var t=Math.floor(Math.random()*(r+1)),a=e[r];e[r]=e[t],e[t]=a}return e},this.removeNullIn=function(e,r){var t=r[e];if(null===t||void 0===t)delete r[e];else if("object"==typeof t)for(var a in t)this.removeNullIn(a,t)},this.removeNull=function(e){for(var r in e)this.removeNullIn(r,e)},this.removeDuplicateObjectsFromArray=function(e,r,t){var a,n=[];a=t?"aping_id":"apingStringified";if(1===e.length)return e;angular.forEach(e,function(e,i){t||(e.$$hashKey=void 0,e[a]=JSON.stringify(e)),!0===r&&(e.apingTempOrder=i),n.push(e)}),n.sort(this.sortArrayByProperty(a));var i,s=[];return angular.forEach(n,function(e){angular.isDefined(i)?angular.isDefined(e[a])&&e[a]!==i&&s.push(e):s.push(e),i=e[a],t||(e[a]=void 0)}),!0===r&&(s.sort(this.sortArrayByProperty("apingTempOrder")),angular.forEach(s,function(e){e.apingTempOrder=void 0})),s},this.mergeDuplicateObjectsFromArray=function(e,r){var t=this,a=[];if(1===e.length)return e;angular.forEach(e,function(e,t){!0===r&&(e.apingTempOrder=t),a.push(e)}),a.sort(this.sortArrayByProperty("aping_id"));var n,i=[];return angular.forEach(a,function(e){t.removeNull(e),angular.isDefined(n)?angular.isDefined(e.aping_id)&&e.aping_id!==n?i.push(e):i[i.length-1]=angular.merge(i[i.length-1],i[i.length-1],e):i.push(e),n=e.aping_id}),!0===r&&(i.sort(this.sortArrayByProperty("apingTempOrder")),angular.forEach(i,function(e){e.apingTempOrder=void 0})),i},this.getTextFromHtml=function(e){return e=e.replace(/&lt;br ?\/\>|&lt;br ?\/&rt;|\<br ?\/\>/g," "),e=e.replace(/<(?:.|\n)*?>/gm,"")},this.getFirstImageFromHtml=function(e){return/<img[^>]+src="([^">]+)/g.exec(e)},this.parseParametersFromUrl=function(e){var r={};return"string"==typeof e&&(r=JSON.parse('{"'+decodeURI(e.replace(/&/g,'","').replace(/=/g,'":"'))+'"}')),r},this.createIdByPropertiesForArray=function(e,r,t){var a=this;return!angular.isUndefined(t)&&angular.isString(t)||(t="aping_id"),angular.isDefined(e)&&angular.isArray(e)&&angular.forEach(e,function(e){e[t]=a.getIdByPropertiesForObject(e,r)}),e},this.getIdByPropertiesForObject=function(e,r){var t=this,a="";if(angular.isDefined(e)&&angular.isObject(e)){var n=[];"["===r.substr(0,1)?n=this.replaceSingleQuotesAndParseJson(r):n.push(r),angular.forEach(n,function(r){a+=t.getValueFromObjectByPropertyString(e,r)})}return a},this.getValueFromObjectByPropertyString=function(e,r,t){var a="";if(angular.isDefined(e)&&angular.isObject(e)){var n=r.split("."),i=e;angular.forEach(n,function(e){angular.isDefined(i[e])&&(i=i[e])}),angular.isDefined(i)&&(a=t&&angular.isObject(i)?JSON.stringify(i):i)}return a}}]),angular.module("jtt_aping").service("apingInputObjects",["apingDefaultSettings",function(e){this.getNew=function(r,t){var a={};switch(r){case"request":a=angular.extend({model:e.model},t)}return a}}]),angular.module("jtt_aping").service("apingModels",[function(){this.getNew=function(e,r){return{platform:r,model:e}}}]),angular.module("jtt_aping_jsonloader",[]).directive("apingJsonloader",["apingUtilityHelper","jsonloaderFactory",function(e,r){return{require:"?aping",restrict:"A",replace:"false",link:function(t,a,n,i){var s=i.getAppSettings();e.parseJsonFromAttributes(n.apingJsonloader,"jsonloader",s).forEach(function(t){if(t.path){var a={path:t.path};if(t.format&&"jsonp"===t.format.toLowerCase()?a.format="jsonp":a.format="json",angular.isUndefined(t.items)&&(t.items=s.items),0===t.items||"0"===t.items)return!1;(t.items<0||isNaN(t.items))&&(t.items=void 0),angular.isDefined(t.orderBy)&&!angular.isString(t.orderBy)&&(t.orderBy=void 0),!angular.isDefined(t.orderReverse)||!0!==t.orderReverse&&"true"!==t.orderReverse||(t.orderReverse=!0),angular.isDefined(t.xAuthToken)&&(a.xAuthToken=t.xAuthToken),r.getJsonData(a).then(function(r){var a=[];if(r.data){var n=r.data;angular.isDefined(t.resultProperty)&&(n=e.getValueFromObjectByPropertyString(n,t.resultProperty,!1)),n.constructor!==Array?a.push(n):(angular.extend(a,n),angular.isDefined(t.orderBy)&&("$RANDOM"===t.orderBy?a=e.shuffleArray(a):a.sort(e.sortArrayByProperty(t.orderBy))),angular.isDefined(t.orderReverse)&&!0===t.orderReverse&&"$RANDOM"!==t.orderBy&&a.reverse(),angular.isUndefined(t.items)?a=n:t.items>0&&a.length>t.items&&(a=a.splice(0,t.items)))}i.concatToResults(a)})}})}}}]).factory("jsonloaderFactory",["$http",function(e){var r={};return r.getJsonData=function(r){var t={};if("jsonp"===r.format){var a={method:"GET",params:{callback:"JSON_CALLBACK"}};return angular.isDefined(r.xAuthToken)&&(a.headers={"X-Auth-Token":r.xAuthToken}),e.jsonp(r.path,a)}var a={method:"GET",url:r.path,params:t};return angular.isDefined(r.xAuthToken)&&(a.headers={"X-Auth-Token":r.xAuthToken}),e(a)},r}]),angular.module("jtt_aping_json_string",[]).directive("apingJsonString",["apingUtilityHelper",function(e){return{require:"?aping",restrict:"A",replace:"false",link:function(r,t,a,n){var i=n.getAppSettings(),s=e.parseJsonFromAttributes(a.apingJsonString,"apingJsonString",i),o=[];s&&(s.constructor===Array?o=s:o.push(s),o.length>0&&n.concatToResults(o))}}}]),angular.module("jtt_aping_ng_array",[]).directive("apingNgArray",["apingUtilityHelper",function(e){return{require:"?aping",restrict:"A",replace:"false",link:function(r,t,a,n){var i=n.getAppSettings();e.parseJsonFromAttributes(a.apingNgArray,"ngArray",i).forEach(function(t){if(t.name&&r[t.name]){if(angular.isUndefined(t.items)&&(t.items=i.items),0===t.items||"0"===t.items)return!1;(t.items<0||isNaN(t.items))&&(t.items=void 0);var a=[];r[t.name].constructor===Array?(a=r[t.name],angular.isDefined(t.orderBy)&&("$RANDOM"===t.orderBy?a=e.shuffleArray(a):a.sort(e.sortArrayByProperty(t.orderBy))),angular.isDefined(t.orderReverse)&&!0===t.orderReverse&&"$RANDOM"!==t.orderBy&&a.reverse(),angular.isDefined(t.items)&&t.items>0&&a.length>t.items&&(a=a.splice(0,t.items))):"object"==typeof r[t.name]&&null!==r[t.name]&&a.push(r[t.name]),a.length>0&&n.concatToResults(a)}})}}}]),angular.module("jtt_aping_local_storage",[]).directive("apingLocalStorage",["apingUtilityHelper","apingLocalStorage",function(e,r){return{require:"?aping",restrict:"A",replace:"false",link:function(t,a,n,i){var s=i.getAppSettings();e.parseJsonFromAttributes(n.apingLocalStorage,"localStorage",s).forEach(function(t){if(t.key){if(angular.isUndefined(t.items)&&(t.items=s.items),0===t.items||"0"===t.items)return!1;(t.items<0||isNaN(t.items))&&(t.items=void 0),angular.isDefined(t.orderBy)&&!angular.isString(t.orderBy)&&(t.orderBy=void 0),!angular.isDefined(t.orderReverse)||!0!==t.orderReverse&&"true"!==t.orderReverse||(t.orderReverse=!0),r.get(t.key).then(function(r){var a=[];if(r){var n=r;angular.isDefined(t.resultProperty)&&(n=e.getValueFromObjectByPropertyString(r,t.resultProperty,!1)),angular.isArray(r)?(a=n,angular.isDefined(t.orderBy)&&("$RANDOM"===t.orderBy?a=e.shuffleArray(a):a.sort(e.sortArrayByProperty(t.orderBy))),angular.isDefined(t.orderReverse)&&!0===t.orderReverse&&"$RANDOM"!==t.orderBy&&a.reverse(),angular.isUndefined(t.items)?a=n:t.items>0&&a.length>t.items&&(a=a.splice(0,t.items))):a.push(n)}i.concatToResults(a)})}})}}}]).factory("apingLocalStorage",["$window","$q",function(e,r){return{set:function(t,a){var n=r.defer();return n.resolve(e.localStorage&&e.localStorage.setItem(t,angular.toJson(a))),n.promise},get:function(t){var a=r.defer();return a.resolve(e.localStorage&&angular.fromJson(e.localStorage.getItem(t))),a.promise}}}]),angular.module("jtt_aping_xml",[]).directive("apingXml",["apingUtilityHelper","xmlFactory","xmlService",function(e,r,t){return{require:"?aping",restrict:"A",replace:"false",link:function(a,n,i,s){var o=s.getAppSettings();e.parseJsonFromAttributes(i.apingXml,"xml",o).forEach(function(a){if(a.path){var n={path:a.path};if(angular.isUndefined(a.items)&&(a.items=o.items),0===a.items||"0"===a.items)return!1;(a.items<0||isNaN(a.items))&&(a.items=void 0),angular.isDefined(a.orderBy)&&!angular.isString(a.orderBy)&&(a.orderBy=void 0),!angular.isDefined(a.orderReverse)||!0!==a.orderReverse&&"true"!==a.orderReverse||(a.orderReverse=!0),r.getData(n).then(function(r){var n=[];if(r.data){var i=t.xml2json(r.data);angular.isDefined(a.resultProperty)&&(i=e.getValueFromObjectByPropertyString(i,a.resultProperty,!1)),i.constructor!==Array?n.push(i):(angular.extend(n,i),angular.isDefined(a.orderBy)&&("$RANDOM"===a.orderBy?n=e.shuffleArray(n):n.sort(e.sortArrayByProperty(a.orderBy))),angular.isDefined(a.orderReverse)&&!0===a.orderReverse&&"$RANDOM"!==a.orderBy&&n.reverse(),angular.isUndefined(a.items)?n=i:a.items>0&&n.length>a.items&&(n=n.splice(0,a.items)))}s.concatToResults(n)})}})}}}]).factory("xmlFactory",["$http",function(e){var r={};return r.getData=function(r){var t={};return e({method:"GET",url:r.path,params:t})},r}]).service("xmlService",function(){var e=this;this.cleanXML=function(r){return r=r.replace(/\n|\t|\r/g,""),r=r.replace(/ {1,}<|\t{1,}</g,"<"),r=r.replace(/> {1,}|>\t{1,}/g,">"),r=r.replace(/<\?[^>]*\?>/g,""),r=e.replaceSelfClosingTags(r),r=e.replaceAloneValues(r),r=e.replaceAttributes(r)},this.replaceSelfClosingTags=function(e){var r=e.match(/<[^\/][^>]*\/>/g);if(r)for(var t=0;t<r.length;t++){var a=r[t],n=a.substring(0,a.length-2);n+=">";var i=a.match(/[^<][\w+$]*/)[0],s="</"+i+">",o="<"+i+">",l=n.match(/(\S+)=["']?((?:.(?!["']?\s+(?:\S+)=|[>"']))+.)["']?/g);if(l)for(var u=0;u<l.length;u++){var g=l[u],d=g.substring(0,g.indexOf("=")),f=g.substring(g.indexOf('"')+1,g.lastIndexOf('"'));o+="<"+d+">"+f+"</"+d+">"}o+=s,e=e.replace(a,o)}return e},this.replaceAloneValues=function(e){var r=e.match(/<[^\/][^>][^<]+\s+.[^<]+[=][^<]+>{1}([^<]+)/g);if(r)for(var t=0;t<r.length;t++){var a=r[t],n=a.substring(0,a.indexOf(">")+1),i=a.substring(a.indexOf(">")+1),s=n+"<_@ttribute>"+i+"</_@ttribute>";e=e.replace(a,s)}return e},this.replaceAttributes=function(e){var r=e.match(/<[^\/][^>][^<]+\s+.[^<]+[=][^<]+>/g);if(r)for(var t=0;t<r.length;t++){var a=r[t],n=a.match(/[^<][\w+$]*/)[0],i="<"+n+">",s=a.match(/(\S+)=["']?((?:.(?!["']?\s+(?:\S+)=|[>"']))+.)["']?/g);if(s)for(var o=0;o<s.length;o++){var l=s[o],u=l.substring(0,l.indexOf("=")),g=l.substring(l.indexOf('"')+1,l.lastIndexOf('"'));i+="<"+u+">"+g+"</"+u+">"}e=e.replace(a,i)}return e},this.xml2json=function(r){r=this.cleanXML(r);for(var t,a,n,i,s,o={};r.match(/<[^\/][^>]*>/);)s=r.match(/<[^\/][^>]*>/)[0],t=s.substring(1,s.length-1),a=r.indexOf(s.replace("<","</")),-1==a&&(t=s.match(/[^<][\w+$]*/)[0],-1==(a=r.indexOf("</"+t))&&(a=r.indexOf("<\\/"+t))),n=r.substring(s.length,a),i=n.match(/<[^\/][^>]*>/)?e.xml2json(n):n,void 0===o[t]?o[t]=i:Array.isArray(o[t])?o[t].push(i):o[t]=[o[t],i],r=r.substring(2*s.length+1+n.length);return o}});